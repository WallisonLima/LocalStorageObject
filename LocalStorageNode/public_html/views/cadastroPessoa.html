<title>Finalizar Compra</title>
<div style="margin-left: 40px;">
    <h2>Finalizar Compra</h2>
    <h3>Por favor, insira os dados para finalizar a compra.</h3>

    <div class="inputData" style="margin-top: 10px;">
        <div class="form-group">
            <label>
                Nome: <input class="form-control" id="nome" name="nome"></label>
            <span id="ErrorNome"></span>
        </div>
        <div class="form-group">
            <label>CPF: <input class="form-control" id="cpf" name="cpf"></label>
            <span id="ErrorCpf"></span><br><br>
        </div>
        Endereço<br>
        <div class="form-group">
            <label>Cep:
                <input name="cep" class="form-control" type="text" id="cep" value="" size="10" maxlength="9"
                    onblur="pesquisacep(this.value);" /></label>
            <span id="ErrorCep"></span>
        </div>
        <div class="form-group">
            <label>Rua:
                <input name="rua" class="form-control" type="text" id="rua" size="60" /></label>
            <span id="ErrorRua"></span>
        </div>
        <div class="form-group">
            <label>Bairro:
                <input name="bairro" class="form-control" type="text" id="bairro" size="40" /></label>
            <span id="ErrorBairro"></span>
        </div>
        <div class="form-group">
            <label>Cidade:
                <input name="cidade" class="form-control" type="text" id="cidade" size="40" /></label>
            <span id="ErrorCidade"></span>
        </div>
        <div class="form-group">
            <label>Estado:
                <input name="uf" class="form-control" type="text" id="uf" size="2" /></label>
            <span id="ErrorEstado"></span><br>
        </div>
        <div class="form-group">
            <label>Email: <input class="form-control" id="email" name="email"></label>
            <span id="ErrorEmail"></span><br><br>
        </div>
    </div><br>
    <table id="tabela" border="1">
        <tbody id="dados" name="tabela">
        </tbody>
    </table>
    <br>
    <div>
        <a class="btn btn-success" id='check' onclick="checkData()">FINALIZAR</a>
    </div><br>
</div>


<script type="text/javascript">
    window.onload = function () {
        carregaTabela();
    };

    function carregaTabela() {
        let carrinho = lerDados("Carrinho");
        let ValorTotal = 0
        let linha = '';
        for (let l = 0; l < carrinho.length; l++) {
            linha += `<tr>`
            let produto = `<td name="produto">${carrinho[l].produto.produto}</td>`
            let preco = `<td name="preco">${carrinho[l].produto.valor}</td>`
            let quant = `<td name="qtd">${carrinho[l].qtd}</td>`
            let totalitem = `<td name="valorTotal">${carrinho[l].produto.valor * carrinho[l].qtd}</td>`
            linha += produto
            linha += preco
            linha += quant
            linha += totalitem
            ValorTotal += (carrinho[l].produto.valor * carrinho[l].qtd);
            linha += `</tr>`
        }
        let val = valor(ValorTotal);
        let linhaTotal = document.createElement('tr')
        linhaTotal.innerHTML = `<tr><td colSpan = 3>Total</td><td>${val}</td></tr>`;
        let product = `<table border="1" >
                                 <thead>
                                     <tr>
                                         <th>Produto</th>
                                         <th>Valor unitário</th>
                                         <th>Quantidade</th>
                                         <th>Total do Item</th>
                                     </tr>
                                 </thead>
                                 <tbody id="tabelaDinamica">
                                    <tr> ${linha} </tr>
                                    <tr> ${linhaTotal.innerHTML}</tr>
                                 </tbody>
                             </table>`
        let cont = document.createElement('div')

        cont.innerHTML += product
        document.getElementById("dados").appendChild(cont);

    };
    function atualizar(dados) {
        let linhas = document.getElementById(dados).rows;
        for (let i = linhas.length - 1; i >= 0; i--) {
            document.getElementById(dados).deleteRow(i);
        }
        carregaTabela();
    }

    async function checkData() {
        return new Promise(async (resolve, reject) => {
            let [resp, nome, cpf, email, cep, rua, bairro, cidade, uf] = await checkDatas();
            if (resp == 'Sucess') {
                let cliente = [nome, cpf, email, cep, rua, bairro, cidade, uf];
                let produtos = await lerDados("Carrinho");
                let pedidos = [];
                pedidos.push(cliente, produtos);
                let respGrava = await gravaDados(cliente[1], pedidos)
                let [client, products] = await getObj(respGrava)
                console.log(products)
                let xhr = new XMLHttpRequest();
                xhr.open("POST", '/cadastro/pedido', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.send(JSON.stringify({
                    client,
                    products
                }));
                document.getElementById('check').href = '/pedidos'
            }
        })
    }

    async function getObj(objePedido) {
        return new Promise(async (resolve, reject) => {
            let pedido = JSON.parse(objePedido)
            let obj = {}
            let client = {
                nome: pedido[0][0],
                cpf: pedido[0][1],
                cep: pedido[0][3],
                rua: pedido[0][4],
                bairro: pedido[0][5],
                cidade: pedido[0][6],
                uf: pedido[0][7],
            }
            let products = pedido[1];

            resolve([client, products]);
        })
    }

    async function checkDatas() {
        return new Promise(async (resolve, reject) => {
            let resp = ''
            let nome = '';
            let cpf = '';
            let email = '';
            let cep = '';
            let rua = '';
            let bairro = '';
            let cidade = '';
            let uf = '';
            if (confereCampo('nome') == true) {
                document.getElementById('ErrorNome').innerHTML = "Digite um nome";
                resp = ''
            } else {
                nome = document.getElementById('nome').value
                document.getElementById('ErrorNome').innerHTML = "";
                resp = 'Sucess'
            }
            if (confereCampo('cpf') == true) {
                document.getElementById('ErrorCpf').innerHTML = "Digite um CPF"
                resp = ''
            } else {
                if (verificaCpf('cpf') == true) {
                    document.getElementById('ErrorCpf').innerHTML = "Digite um CPF válido"
                    resp = ''
                } else {
                    cpf = document.getElementById('cpf').value
                    document.getElementById('ErrorCpf').innerHTML = ""
                    resp = 'Sucess'
                }
            }
            if (confereCampo('email') == true) {
                document.getElementById('ErrorEmail').innerHTML = "Digite um e-mail"
                resp = ''
            } else {
                if (verificaEmail('email') == true) {
                    document.getElementById('ErrorEmail').innerHTML = "Digite um EMAIL válido"
                    resp = ''
                } else {
                    email = document.getElementById('email').value
                    document.getElementById('ErrorEmail').innerHTML = ""
                    resp = 'Sucess'
                }
            }
            if (confereCampo('cep') == true) {
                document.getElementById('ErrorCep').innerHTML = "Digite um Cep"
                resp = ''
            }
            else {
                cep = document.getElementById('cep').value
                rua = document.getElementById('rua').value
                bairro = document.getElementById('bairro').value
                cidade = document.getElementById('cidade').value
                uf = document.getElementById('uf').value
                resp = 'Sucess'
            }
            resolve([resp, nome, cpf, email, cep, rua, bairro, cidade, uf])
        })
    }


</script>
<script src="../js/funcoes.js"></script>
</body>


</html>